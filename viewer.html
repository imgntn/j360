<!DOCTYPE html>
<html>
<body>
<video id="view" autoplay playsinline style="width:100%;max-width:100%"></video>
<div id="status" style="position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.5);color:white;padding:4px"></div>
<progress id="progress-bar" value="0" max="100" style="position:absolute;top:40px;left:10px;width:calc(100% - 20px);display:none"></progress>
<script>
const video = document.getElementById('view');
const ws = new WebSocket(`ws://${location.hostname}:3000`);
const pc = new RTCPeerConnection();
pc.ontrack = e => {
  if (video.srcObject !== e.streams[0]) video.srcObject = e.streams[0];
};
pc.onicecandidate = e => { if (e.candidate) ws.send(JSON.stringify({ candidate: e.candidate })); };
ws.onmessage = async e => {
  try {
    const msg = JSON.parse(e.data);
    if (msg.offer) {
      await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ answer }));
    } else if (msg.candidate) {
      await pc.addIceCandidate(msg.candidate);
    }
  } catch {}
};
const status = document.getElementById('status');
const bar = document.getElementById('progress-bar');
const ws2 = new WebSocket(`ws://${location.hostname}:4000`);
ws2.onmessage = e => {
  try {
    const msg = JSON.parse(e.data);
    if (msg.progress !== undefined) {
      status.textContent = `${msg.mode||''} ${msg.progress}% ${msg.frame||0}f ${msg.elapsed||0}s`;
      if (bar) { bar.style.display = 'block'; bar.value = msg.progress; }
    } else if (msg.status) {
      status.textContent = msg.status;
      if (bar) { bar.style.display = 'none'; bar.value = 0; }
    }
  } catch {}
};
</script>
</body>
</html>
